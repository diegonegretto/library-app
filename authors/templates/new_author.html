{% extends "base.html" %}

{% block title %}Cadastrar Autor - Biblioteca Digital{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{% url 'books_list' %}" class="text-decoration-none">
                <i class="bi bi-house me-1"></i>Biblioteca
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="{% url 'authors_list' %}" class="text-decoration-none">
                Autores
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            Cadastrar Autor
        </li>
    </ol>
</nav>

<!-- Page Header -->
<div class="row align-items-center mb-4">
    <div class="col">
        <h1 class="h2 text-primary mb-1">
            <i class="bi bi-person-plus me-2"></i>Cadastrar Novo Autor
        </h1>
        <p class="text-muted mb-0">Adicione um novo escritor à sua biblioteca digital</p>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card border-0 shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-person-badge me-2"></i>Informações do Autor
                </h5>
            </div>

            <div class="card-body p-4">
                <!-- Error Messages -->
                {% if form.errors %}
                <div class="alert alert-danger d-flex align-items-start mb-4" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2 mt-1"></i>
                    <div>
                        <strong>Por favor, corrija os erros abaixo:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Campos marcados com * são obrigatórios</li>
                        </ul>
                    </div>
                </div>
                {% endif %}

                <form method="POST" enctype="multipart/form-data" id="authorForm" novalidate>
                    {% csrf_token %}

                    <div class="row g-4">
                        <!-- Name Field -->
                        <div class="col-12">
                            <label for="id_name" class="form-label fw-semibold">
                                <i class="bi bi-person me-2 text-primary"></i>Nome Completo *
                            </label>
                            <input type="text" class="form-control form-control-lg" id="id_name" name="name"
                                placeholder="Digite o nome completo do autor" required>
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>
                                Nome completo do escritor (ex: Machado de Assis)
                            </div>
                        </div>

                        <!-- Birth Date and Nationality Row -->
                        <div class="col-md-6">
                            <label for="id_birth_date" class="form-label fw-semibold">
                                <i class="bi bi-calendar3 me-2 text-primary"></i>Data de Nascimento
                            </label>
                            <input type="date" class="form-control form-control-lg" id="id_birth_date"
                                name="birth_date">
                            <div class="form-text">
                                <i class="bi bi-cake me-1"></i>
                                Data de nascimento do autor
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label for="id_nationality" class="form-label fw-semibold">
                                <i class="bi bi-geo-alt me-2 text-primary"></i>Nacionalidade
                            </label>
                            <input type="text" class="form-control form-control-lg" id="id_nationality"
                                name="nationality" placeholder="Ex: Brasileira, Portuguesa, Argentina"
                                list="nationalityList">
                            <datalist id="nationalityList">
                                <option value="Brasileira">
                                <option value="Portuguesa">
                                <option value="Americana">
                                <option value="Inglesa">
                                <option value="Francesa">
                                <option value="Espanhola">
                                <option value="Argentina">
                                <option value="Alemã">
                                <option value="Italiana">
                                <option value="Japonesa">
                            </datalist>
                            <div class="form-text">
                                <i class="bi bi-flag me-1"></i>
                                País de origem do autor
                            </div>
                        </div>

                        <!-- Biography Field -->
                        <div class="col-12">
                            <label for="id_biography" class="form-label fw-semibold">
                                <i class="bi bi-journal-text me-2 text-primary"></i>Biografia
                            </label>
                            <textarea class="form-control" id="id_biography" name="biography" rows="5"
                                placeholder="Escreva uma breve biografia do autor: vida, obras principais, prêmios, estilo literário, influências..."></textarea>
                            <div class="form-text">
                                <i class="bi bi-chat-left-text me-1"></i>
                                História e informações relevantes sobre o autor
                                <span class="float-end text-muted" id="bioCharCount">0/2000 caracteres</span>
                               <br>* Caso este campo seja deixado vazio, será gerado automaticamente uma mini-biografia por IA
                            </div>
                        </div>

                        <!-- Photo Upload Field -->
                        <div class="col-12">
                            <label for="id_photo" class="form-label fw-semibold">
                                <i class="bi bi-image me-2 text-primary"></i>Foto do Autor
                            </label>
                            <div class="card border-2 border-dashed">
                                <div class="card-body text-center py-4">
                                    <div class="mb-3">
                                        <i class="bi bi-person-circle text-muted" style="font-size: 4rem;"></i>
                                    </div>
                                    <input type="file" class="form-control" id="id_photo" name="photo" accept="image/*">
                                    <div class="form-text mt-3">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Formatos aceitos: JPG, PNG, GIF (máx. 5MB)
                                    </div>

                                    <!-- Preview Area -->
                                    <div id="imagePreview" class="mt-3" style="display: none;">
                                        <img id="previewImg" class="img-thumbnail rounded-circle"
                                            style="max-height: 200px; max-width: 200px; object-fit: cover;">
                                        <div class="mt-2">
                                            <button type="button" class="btn btn-sm btn-outline-danger"
                                                onclick="removeImage()">
                                                <i class="bi bi-trash me-1"></i>Remover Foto
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Required Fields Info -->
                    <div class="alert alert-info d-flex align-items-center mt-4">
                        <i class="bi bi-asterisk me-2"></i>
                        <small>Campos marcados com * são obrigatórios</small>
                    </div>

                    <!-- Form Actions -->
                    <div class="row g-3 mt-4">
                        <div class="col-md-4">
                            <button type="button" class="btn btn-outline-secondary btn-lg w-100"
                                onclick="window.history.back()">
                                <i class="bi bi-arrow-left me-2"></i>Voltar
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button type="reset" class="btn btn-outline-warning btn-lg w-100"
                                onclick="return confirm('Tem certeza que deseja limpar todos os campos?')">
                                <i class="bi bi-arrow-clockwise me-2"></i>Limpar Tudo
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary btn-lg w-100" id="submitBtn">
                                <i class="bi bi-check-circle me-2"></i>Cadastrar Autor
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tips Card -->
        <div class="card border-0 bg-light mt-4">
            <div class="card-body">
                <h6 class="fw-bold text-primary mb-3">
                    <i class="bi bi-lightbulb me-2"></i>Dicas para um bom cadastro:
                </h6>
                <div class="row g-3">
                    <div class="col-md-6">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <i class="bi bi-check2 text-success me-2"></i>
                                Use o nome completo do autor
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check2 text-success me-2"></i>
                                Inclua data de nascimento quando possível
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check2 text-success me-2"></i>
                                Especifique a nacionalidade corretamente
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <i class="bi bi-check2 text-success me-2"></i>
                                Escreva uma biografia informativa
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check2 text-success me-2"></i>
                                Use uma foto de boa qualidade
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check2 text-success me-2"></i>
                                Mencione obras e prêmios na biografia
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('authorForm');
        const submitBtn = document.getElementById('submitBtn');
        const biographyField = document.getElementById('id_biography');
        const bioCharCount = document.getElementById('bioCharCount');
        const photoInput = document.getElementById('id_photo');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');

        // Character counter for biography
        if (biographyField && bioCharCount) {
            biographyField.addEventListener('input', function () {
                const currentLength = this.value.length;
                const maxLength = 2000;
                bioCharCount.textContent = `${currentLength}/${maxLength} caracteres`;

                if (currentLength > maxLength * 0.9) {
                    bioCharCount.classList.add('text-warning');
                } else {
                    bioCharCount.classList.remove('text-warning');
                }

                if (currentLength > maxLength) {
                    bioCharCount.classList.add('text-danger');
                    this.value = this.value.substring(0, maxLength);
                } else {
                    bioCharCount.classList.remove('text-danger');
                }
            });
        }

        // Image preview functionality
        if (photoInput) {
            photoInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    // Validate file size (5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('Arquivo muito grande! Por favor, selecione uma imagem menor que 5MB.');
                        this.value = '';
                        return;
                    }

                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        alert('Por favor, selecione apenas arquivos de imagem.');
                        this.value = '';
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        previewImg.src = e.target.result;
                        imagePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Form submission handling
        form.addEventListener('submit', function (e) {
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Cadastrando...';

            // Restore if there's an error (fallback)
            setTimeout(() => {
                if (submitBtn.disabled) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            }, 10000);
        });

        // Form validation
        const requiredFields = document.querySelectorAll('input[required]');
        requiredFields.forEach(field => {
            field.addEventListener('blur', function () {
                validateField(this);
            });

            field.addEventListener('input', function () {
                if (this.classList.contains('is-invalid')) {
                    validateField(this);
                }
            });
        });

        function validateField(field) {
            if (field.hasAttribute('required') && !field.value.trim()) {
                field.classList.add('is-invalid');
                field.classList.remove('is-valid');
            } else if (field.value.trim()) {
                field.classList.remove('is-invalid');
                field.classList.add('is-valid');
            } else {
                field.classList.remove('is-invalid', 'is-valid');
            }
        }

        // Birth date validation (não pode ser futura)
        const birthDateField = document.getElementById('id_birth_date');
        if (birthDateField) {
            birthDateField.addEventListener('change', function () {
                const selectedDate = new Date(this.value);
                const today = new Date();

                if (selectedDate > today) {
                    alert('A data de nascimento não pode ser no futuro.');
                    this.value = '';
                    this.classList.add('is-invalid');
                } else if (this.value) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                }
            });

            // Set max date to today
            const today = new Date().toISOString().split('T')[0];
            birthDateField.setAttribute('max', today);
        }

        // Auto-focus on first field
        const firstField = document.getElementById('id_name');
        if (firstField) {
            firstField.focus();
        }

        // Reset form confirmation
        const resetBtn = document.querySelector('button[type="reset"]');
        if (resetBtn) {
            resetBtn.addEventListener('click', function (e) {
                const confirmed = confirm('Tem certeza que deseja limpar todos os campos?\n\nTodos os dados digitados serão perdidos.');
                if (confirmed) {
                    // Clear validation classes
                    requiredFields.forEach(field => {
                        field.classList.remove('is-valid', 'is-invalid');
                    });

                    // Clear image preview
                    imagePreview.style.display = 'none';
                    previewImg.src = '';

                    // Reset character counter
                    if (bioCharCount) {
                        bioCharCount.textContent = '0/2000 caracteres';
                        bioCharCount.classList.remove('text-warning', 'text-danger');
                    }
                } else {
                    e.preventDefault();
                }
            });
        }

        // Name field validation (minimum 3 characters)
        const nameField = document.getElementById('id_name');
        if (nameField) {
            nameField.addEventListener('input', function () {
                const value = this.value.trim();
                if (value.length > 0 && value.length < 3) {
                    this.classList.add('is-invalid');
                    this.classList.remove('is-valid');
                } else if (value.length >= 3) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                } else {
                    this.classList.remove('is-invalid', 'is-valid');
                }
            });
        }

        // Nationality field - convert to title case
        const nationalityField = document.getElementById('id_nationality');
        if (nationalityField) {
            nationalityField.addEventListener('blur', function () {
                if (this.value) {
                    this.value = this.value.charAt(0).toUpperCase() + this.value.slice(1).toLowerCase();
                    this.classList.add('is-valid');
                }
            });
        }
    });

    // Function to remove uploaded image
    function removeImage() {
        const photoInput = document.getElementById('id_photo');
        const imagePreview = document.getElementById('imagePreview');

        photoInput.value = '';
        imagePreview.style.display = 'none';
    }
</script>
{% endblock %}