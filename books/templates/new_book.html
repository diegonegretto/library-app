{% extends "base.html" %}

{% block title %}Cadastrar Livro - Biblioteca Digital{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{% url 'books_list' %}" class="text-decoration-none">
                <i class="bi bi-house me-1"></i>Biblioteca
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            Cadastrar Livro
        </li>
    </ol>
</nav>

<!-- Page Header -->
<div class="row align-items-center mb-4">
    <div class="col">
        <h1 class="h2 text-primary mb-1">
            <i class="bi bi-book-half me-2"></i>Cadastrar Novo Livro
        </h1>
        <p class="text-muted mb-0">Adicione um novo livro à sua biblioteca digital</p>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card border-0 shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-plus-circle me-2"></i>Informações do Livro
                </h5>
            </div>

            <div class="card-body p-4">
                <!-- Error Messages -->
                {% if form.errors %}
                <div class="alert alert-danger d-flex align-items-start mb-4" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2 mt-1"></i>
                    <div>
                        <strong>Por favor, corrija os erros abaixo:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Campos marcados com * são obrigatórios</li>                            
                        </ul>
                    </div>
                </div>
                {% endif %}

                <form method="POST" enctype="multipart/form-data" id="bookForm" novalidate>
                    {% csrf_token %}

                    <div class="row g-4">
                        <!-- Title Field -->
                        <div class="col-12">
                            <label for="id_title" class="form-label fw-semibold">
                                <i class="bi bi-book me-2 text-primary"></i>Título *
                            </label>
                            <input type="text" class="form-control form-control-lg" id="id_title" name="title"
                                placeholder="Digite o título do livro" required>
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>
                                Nome completo da obra
                            </div>
                        </div>

                        <!-- Author Field -->
                        <div class="col-md-6">
                            <label for="id_author" class="form-label fw-semibold">
                                <i class="bi bi-person me-2 text-primary"></i>Autor *
                            </label>
                            <div class="input-group">
                                <select class="form-select form-select-lg" id="id_author" name="author" required>
                                    <option value="">Selecione um autor</option>
                                    {% for author in authors %}
                                    <option value="{{ author.id }}">{{ author.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-text">
                                <i class="bi bi-lightbulb me-1"></i>
                                Selecione da lista ou <a href="{% url 'new_author' %}">adicione novo autor</a>
                            </div>
                        </div>

                        <!-- Genre Field -->
                        <div class="col-md-6">
                            <label for="id_literary_genre" class="form-label fw-semibold">
                                <i class="bi bi-tag me-2 text-primary"></i>Gênero Literário *
                            </label>
                            <div class="input-group">
                                <select class="form-select form-select-lg" id="id_literary_genre" name="literary_genre"
                                    required>
                                    <option value="">Selecione um gênero</option>
                                    {% for genre in genres %}
                                    <option value="{{ genre.id }}">{{ genre.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-text">
                                <i class="bi bi-question-circle me-1"></i>
                                Selecione da lista ou <a href="{% url 'new_genre' %}">adicione novo gênero</a>
                            </div>
                        </div>

                        <!-- Pages and Year Row -->
                        <div class="col-md-6">
                            <label for="id_pages" class="form-label fw-semibold">
                                <i class="bi bi-file-text me-2 text-primary"></i>Número de Páginas
                            </label>
                            <input type="number" class="form-control form-control-lg" id="id_pages" name="pages"
                                placeholder="Ex: 350" min="1" max="9999">
                            <div class="form-text">
                                <i class="bi bi-calculator me-1"></i>
                                Total de páginas do livro
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label for="id_publication_year" class="form-label fw-semibold">
                                <i class="bi bi-calendar3 me-2 text-primary"></i>Ano de Publicação
                            </label>
                            <input type="number" class="form-control form-control-lg" id="id_publication_year"
                                name="publication_year" placeholder="Ex: 2023" min="1000" max="2030">
                            <div class="form-text">
                                <i class="bi bi-clock me-1"></i>
                                Ano da primeira publicação
                            </div>
                        </div>

                        <!-- Synopsis Field -->
                        <div class="col-12">
                            <label for="id_synopsis" class="form-label fw-semibold">
                                <i class="bi bi-journal-text me-2 text-primary"></i>Sinopse
                            </label>
                            <textarea class="form-control" id="id_synopsis" name="synopsis" rows="4"
                                placeholder="Descreva brevemente o enredo, personagens principais e temas abordados no livro..."></textarea>
                            <div class="form-text">
                                <i class="bi bi-chat-left-text me-1"></i>
                                Resumo do livro para outros leitores
                                <span class="float-end text-muted" id="charCount">0/1000 caracteres</span>
                                <br>
                                * Caso este campo seja deixado vazio, será gerado automaticamente uma mini-sinopse por IA
                            </div>
                        </div>

                        <!-- Photo Upload Field -->
                        <div class="col-12">
                            <label for="id_photo" class="form-label fw-semibold">
                                <i class="bi bi-image me-2 text-primary"></i>Foto da Capa
                            </label>
                            <div class="card border-2 border-dashed">
                                <div class="card-body text-center py-4">
                                    <div class="mb-3">
                                        <i class="bi bi-cloud-upload text-muted display-4"></i>
                                    </div>
                                    <input type="file" class="form-control" id="id_photo" name="photo" accept="image/*">
                                    <div class="form-text mt-3">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Formatos aceitos: JPG, PNG, GIF (máx. 5MB)
                                    </div>

                                    <!-- Preview Area -->
                                    <div id="imagePreview" class="mt-3" style="display: none;">
                                        <img id="previewImg" class="img-thumbnail" style="max-height: 200px;">
                                        <div class="mt-2">
                                            <button type="button" class="btn btn-sm btn-outline-danger"
                                                onclick="removeImage()">
                                                <i class="bi bi-trash me-1"></i>Remover Imagem
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Required Fields Info -->
                    <div class="alert alert-info d-flex align-items-center mt-4">
                        <i class="bi bi-asterisk me-2"></i>
                        <small>Campos marcados com * são obrigatórios</small>
                    </div>

                    <!-- Form Actions -->
                    <div class="row g-3 mt-4">
                        <div class="col-md-4">
                            <button type="button" class="btn btn-outline-secondary btn-lg w-100"
                                onclick="window.history.back()">
                                <i class="bi bi-arrow-left me-2"></i>Voltar
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button type="reset" class="btn btn-outline-warning btn-lg w-100"
                                onclick="return confirm('Tem certeza que deseja limpar todos os campos?')">
                                <i class="bi bi-arrow-clockwise me-2"></i>Limpar Tudo
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary btn-lg w-100" id="submitBtn">
                                <i class="bi bi-check-circle me-2"></i>Cadastrar Livro
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tips Card -->
        <div class="card border-0 bg-light mt-4">
            <div class="card-body">
                <h6 class="fw-bold text-primary mb-3">
                    <i class="bi bi-lightbulb me-2"></i>Dicas para um bom cadastro:
                </h6>
                <div class="row g-3">
                    <div class="col-md-6">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <i class="bi bi-check2 text-success me-2"></i>
                                Use o título completo e correto
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check2 text-success me-2"></i>
                                Selecione o autor da lista ou adicione novo
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check2 text-success me-2"></i>
                                Verifique o ano de publicação
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <i class="bi bi-check2 text-success me-2"></i>
                                Escreva uma sinopse interessante
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check2 text-success me-2"></i>
                                Use uma capa de boa qualidade
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check2 text-success me-2"></i>
                                Categorize com o gênero apropriado
                            </li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('bookForm');
        const submitBtn = document.getElementById('submitBtn');
        const synopsisField = document.getElementById('id_synopsis');
        const charCount = document.getElementById('charCount');
        const photoInput = document.getElementById('id_photo');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');

        // Character counter for synopsis
        if (synopsisField && charCount) {
            synopsisField.addEventListener('input', function () {
                const currentLength = this.value.length;
                const maxLength = 1000;
                charCount.textContent = `${currentLength}/${maxLength} caracteres`;

                if (currentLength > maxLength * 0.9) {
                    charCount.classList.add('text-warning');
                } else {
                    charCount.classList.remove('text-warning');
                }

                if (currentLength > maxLength) {
                    charCount.classList.add('text-danger');
                    this.value = this.value.substring(0, maxLength);
                } else {
                    charCount.classList.remove('text-danger');
                }
            });
        }

        // Image preview functionality
        if (photoInput) {
            photoInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    // Validate file size (5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('Arquivo muito grande! Por favor, selecione uma imagem menor que 5MB.');
                        this.value = '';
                        return;
                    }

                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        alert('Por favor, selecione apenas arquivos de imagem.');
                        this.value = '';
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        previewImg.src = e.target.result;
                        imagePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Form submission handling
        form.addEventListener('submit', function (e) {
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Cadastrando...';

            // Restore if there's an error (fallback)
            setTimeout(() => {
                if (submitBtn.disabled) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            }, 10000);
        });

        // Form validation
        const requiredFields = document.querySelectorAll('input[required], select[required]');
        requiredFields.forEach(field => {
            field.addEventListener('blur', function () {
                validateField(this);
            });

            field.addEventListener('input', function () {
                if (this.classList.contains('is-invalid')) {
                    validateField(this);
                }
            });
        });

        function validateField(field) {
            if (field.hasAttribute('required') && !field.value.trim()) {
                field.classList.add('is-invalid');
                field.classList.remove('is-valid');
            } else if (field.type === 'number') {
                const value = parseInt(field.value);
                const min = parseInt(field.getAttribute('min'));
                const max = parseInt(field.getAttribute('max'));

                if (field.value && (value < min || value > max)) {
                    field.classList.add('is-invalid');
                    field.classList.remove('is-valid');
                } else if (field.value) {
                    field.classList.remove('is-invalid');
                    field.classList.add('is-valid');
                }
            } else if (field.value.trim()) {
                field.classList.remove('is-invalid');
                field.classList.add('is-valid');
            } else {
                field.classList.remove('is-invalid', 'is-valid');
            }
        }

        // Auto-focus on first field
        const firstField = document.getElementById('id_title');
        if (firstField) {
            firstField.focus();
        }

        // Reset form confirmation
        const resetBtn = document.querySelector('button[type="reset"]');
        resetBtn.addEventListener('click', function (e) {
            const confirmed = confirm('Tem certeza que deseja limpar todos os campos?\n\nTodos os dados digitados serão perdidos.');
            if (confirmed) {
                // Clear validation classes
                requiredFields.forEach(field => {
                    field.classList.remove('is-valid', 'is-invalid');
                });

                // Clear image preview
                imagePreview.style.display = 'none';
                previewImg.src = '';

                // Reset character counter
                if (charCount) {
                    charCount.textContent = '0/1000 caracteres';
                    charCount.classList.remove('text-warning', 'text-danger');
                }
            } else {
                e.preventDefault();
            }
        });
    });

    // Function to remove uploaded image
    function removeImage() {
        const photoInput = document.getElementById('id_photo');
        const imagePreview = document.getElementById('imagePreview');

        photoInput.value = '';
        imagePreview.style.display = 'none';
    }
</script>
{% endblock %}